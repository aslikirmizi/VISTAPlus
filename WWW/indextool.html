<html>
<head>
    <!-- Libraries used to create the web tool-->
    <script src="dependencies/jquery/jquery.min.js"></script>
    <script src="dependencies/vis/vis-network.min.js"></script>
    <script src="dependencies/html2canvas/html2canvas.min.js"></script>
    <script src="dependencies/materialize-css/js/materialize.min.js"></script>
    <script src="dependencies/heatmap.js-2.0.5/build/heatmap.js"></script>
    <script src="dependencies/heatmap.js-2.0.5/build/heatmap.min.js"></script>

    <script src="dependencies/anime-master/lib/anime.js"></script>  <!-- animated sta map library -->
    <script src="dependencies/anime-master/lib/anime.min.js"></script>  <!-- animated sta map library -->
    <script src="dependencies/anime-master/lib/anime.es.js"></script>  <!-- animated sta map library -->


    <link rel="stylesheet" href="dependencies/vis/vis-network.min.css">
    <link rel="stylesheet" href="dependencies/materialize-css/css/materialize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="dependencies/vistaplus.css">


    <script src="source/vista.js"></script><!--source code-->
    <link rel="stylesheet" href="source/vista.css">
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="fav.ico" />

    <title>Welcome to Vista+ Tool</title><!--header-->

</head>

<body>

    <!-- TOP SECTION MANAGEMENT BUTTONS-->
    <section id="home" class="video-hero" style="height: 100px; background-image: url(images/deneme.jpg);  background-size:cover; background-position: center center;background-attachment:fixed;" data-section="home">

        <div class="buttonkk" style="left:30%; top:5%">
            <label id="dataAddTrigger" class="buttonk button1" style="vertical-align:middle">
                <span> Click Here To Add Data!</span><input style="display: none;" type="file" name="file[]" onchange='vistaModule.readFile(this)' ;
                                                            multiple />
            </label>
        </div>

        <div class="buttonkk" style="left:50%; top:5%">
            <div id="managementModal" style="right: 35px;top:500px">
                <a id="managementTrigger" class="buttonk button1" href="#managementModal">
                    <span>Preferences</span>
                </a>
            </div>
        </div>


        <div class="buttonkk" style="left:65%; top:5%">
            <a id="dataSelectionTrigger" class="modal-trigger buttonk button1 hide"
               href="#dataSelectionModal">
                <span>Select Stimuli</span>
            </a>
        </div>

        <div class="buttonkk" style="left: 80%; top: 5%">

            <a download="save.png" id="imageDownloadTrigger" style="margin-right: 60px;" class=" modal-trigger buttonk button1 hide">
                <span>Download STA Image</span>
            </a>
        </div>

    </section>
   
    <div class="row">

        <div class="col s12">

            <div style="padding: 0px" class="card-panel outer">


                <!-- VISUALISATION METHOD SELECTION-->

                <ul id="visualMethodSelector" class="tabs">
                    <li id="methodGazePath" data-type="GAZEPATH" class="buttona buttona1">
                        <div class="active" href="#">Gaze Path</div>
                    </li>

                    <!-- heatmap function will be binded to here-->
                    <li id="methodHeatMap" data-type="HEATMAP" class="buttona buttona1">
                        <div class="active">
                            Heat Map
                            <a href="#"><font color="#000000"></font></a>
                        </div>
                    </li>

                    <li id="methodSTAMap" data-type="STAMAP" class="tooltip buttona buttona1">
                        <div class="active">
                            STA<span class="tooltiptext" id="toolbox">
                                <pre>Not activated until
AOIs are selected.</pre>
                            </span>
                            <a href="#"><font color="#000000"></font></a>
                        </div>
                    </li>

                    <li id="methodAnimatedSTA" data-type="AnimatedSTA" class="buttona buttona1">
                        <div class="active">
                            Animated STA
                            <a href="#"><font color="#000000"></font></a>
                        </div>
                    </li>
                </ul>
                <!-- SELECTION PART ENDED-->

                <div class="outer">
                    <div id="background" style="z-index: 1;">
                        <div class="inner" id="map" style="z-index: 2;"></div>
                    </div>
                </div>

            </div>


            <!-- Loading Animation -->
            <div id="mapLoader" class="preloader-wrapper big active inner hide">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-yellow">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-green">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <!-- Loading Animation Ends-->

        </div>
    </div>

    <!-- Stimuli Viewing Section -->
    <div id="dataSelectionModal" class="modal bottom-sheet modal-fixed-footer">
        <div class="modal-content black-text">
            <h4 style="text-align:center;">List of Detected Stimulis</h4>
            <p style="text-align:center;">Please select a stimuli from the list below.</p>
            <ul id="dataSelectionList" class="collapsible popout black-text" data-collapsible="accordion">
            </ul>
        </div>
        <div class="modal-footer">
            <a id="dataSelectionButton" href="#" class="modal-action modal-close waves-effect waves-green btn-flat ">Visualize Gazepath</a>
        </div>
    </div>
    <!-- Stimuli Viewing Section Ends -->
    <!-- STA Settings Panel -->
    <div id="managementModal" class="modal modal-fixed-footer">
        <div class="modal-content black-text">
            <h4>Settings</h4>
            <p>You can manage ViSTA+ here.</p>
            <div class="row">
                <form id="settingsForm" class="col s12">
                    <div class="row">
                        <div class="input-field col s6">
                            <input id="setting_width" type="text">
                            <label for="setting_width">Resolution Width</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="setting_height" type="text">
                            <label for="setting_height">Resolution Height</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                            <input id="setting_inch" type="text">
                            <label for="setting_inch">Screen Inch</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="setting_distance" type="text">
                            <label for="setting_distance">Distance to Tracker</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="setting_daccuracy" type="text">
                            <label for="setting_daccuracy">Degree of Accuracy</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col 6">
                            <input id="setting_tolarancelevel" type="text">
                            <label for="setting_tolarancelevel">Tolarance Level</label>
                        </div>
                        <div class="input-field col 6">
                            <input id="setting_highestfidelity" type="checkbox">
                            <label for="setting_highestfidelity">Highest Fidelity</label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a id="managementButton" href="#" class="modal-action modal-close buttonk button1 ">Save</a>
        </div>
    </div>
    <!-- STA Setting Panel Ending -->



</body>

<script type="text/javascript">
    var settings = {
        sta: {
            daccuracy: 0.5,
            sizeOfScreen: 17,
            distance: 60,
            resX: 1280,
            resY: 1024,
            tlevel: 1.00,
            hfidelity: true
        },
        staAddress: "http://mcanatalay.pythonanywhere.com/"
    };

    var discovery = true;
    var selectedStimuliName = "";

    var selectedVisualMethod;
    var prevVisualMethod = "";
    var filter = new Array();
    var vistaModule;
    var mapContainer = document.getElementById('map');
    var listContainer = "map";
    var listener = function (response) {

        if (response == "DATACHANGE") {
            updateDataList();
        } else if (response == "LOADERSTART") {
            showLoader();
        } else if (response == "LOADEREND") {
            removeLoader();
        } else if (response == "UPDATEAOIS") {
            controlVisualMethods();
            drawAOIs();
        } else if (response == "IMGDOWNLOAD") {
            showDownloadLink(vistaModule.getDownloadImage());
        }
    }

    function createDataSelectionList() {
        var list = vistaModule.getListOfCategories();
        var ulHTML = "";
        for (var i = 0; list.length > i; i++) {
            var element = list[i];

            filter[element["name"]] = {
                participants: element["participants"],
                img: null
            };

            var liHTML = '<li data-stimuliname="' + element["name"] + '">' +
                '<div class="collapsible-header">';
            if (element["title"] == null) {
                liHTML +=
                    '<i class="material-icons unselectable">filter_drama</i>' + element["name"] + '</div>';
            } else {
                liHTML +=
                    '<i class="material-icons unselectable">filter_drama</i>' + element["title"] + '</div>';
            }
            liHTML +=
                '<div style="padding: 10px;" class="collapsible-body">' +
                '<form class="col s12" action="#">' +
                '<div class="row">' +
                '<p>Participants</p>' +
                '<p>Choose which participants to include. (All is selected by default) </p>';

            for (var j = 0; element["participants"].length > j; j++) {
                var innerElement = element["participants"][j];
                liHTML += '<div style="color:red;" class="input-field col s3" id="">' +
                    '<input type="checkbox" value="1" class="participant" data-name="' + element["name"] + '" data-participant="' + innerElement + '" id="check-' + i + '-' + innerElement + '" checked/>' +
                    '<label style="color:black;" for="check-' + i + '-' + innerElement + '">Participant ' + innerElement + '</label>' +
                    '</div>';
            }

            liHTML +=
                '<div style="padding: 25px;" class="input-field col s12">' +
                '<h9>You can also browse and upload a stimuli from your computer.</h9>' +
                '<div class="file-field input-field">' +
                '<div class="waves-effect waves-light btn red">' +
                '<i class="material-icons">insert_photo</i>' +
                '<input class="imgurl" placeholder="Image URL" data-name="' + element["name"] + '" id="' + element["name"] + '_IMG" type="file">' +
                '</div>' +
                '<div class="file-path-wrapper">' +
                '<input id="' + element["name"] + '_URL" class="file-path validate" type="text" value="">' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</form>' +
                '</div>' +
                '</li>';

            ulHTML += liHTML;
        }
        return ulHTML;
    }

    function updateDataList() {
        $('#dataSelectionTrigger').removeClass("hide");
        $('#dataSelectionTrigger').addClass('pulse');
        $('#dataSelectionList').html(createDataSelectionList());
    }

    function showLoader() {
        $('#mapLoader').removeClass("hide");
        $('#mapLoader').show();
        $('#background').addClass("hide");
        $('#imageDownloadTrigger').addClass("hide");
        $('#map').css("opacity", "0");
    }

    function removeLoader() {
        $('#mapLoader').hide();
        $('#background').removeClass("hide");
        $('#map').css("opacity", "1");
        vistaModule.createDownloadImage(selectedStimuliName);
    }

    function showDownloadLink(imgLink) {
        $('#imageDownloadTrigger').attr("href", imgLink);
        $('#imageDownloadTrigger').removeClass("hide");
    }

    function controlVisualMethods() {
        if (!vistaModule.isSTAMAPApplicable()) {
            $('#methodSTAMap').addClass("disabled");
            $('methodAnimatedSTA').addClass("disabled");
        } else {
            $('#methodSTAMap').removeClass("disabled");
            $('#toolbox').hide();
            $('#methodAnimatedSTA').removeClass("disabled");
        }
    }

    function resetVisualMethods() {
        clearAOIs();
        prevVisualMethod = "GAZEPATH";
        selectedVisualMethod = "GAZEPATH";
        $('#visualMethodSelector').find("li").removeClass("disabled");
        $('#visualMethodSelector').find("a").removeClass("active");
        $('#methodGazePath').find("a").addClass("active");
        vistaModule.addAOIBlock(false);
        controlVisualMethods();
    }

    function resetForHeatmapMethod() {
        prevVisualMethod = "GAZEPATH";
        clearAOIs();
        selectedVisualMethod = "HEATMAP";
        $('#visualMethodSelector').find("li").removeClass("active");
        vistaModule.addAOIBlock(false);
        controlVisualMethods();
    }

    function clearAOIs() {
        $('.vis-network').parent().find('.aois').remove();
    }

    function prependEle(parent, child) {
        parent.insertBefore(child, parent.firstChild);
    }

    function drawAOIs() {
        if (selectedVisualMethod == "GAZEPATH") {
            clearAOIs();
            $('.vis-network').parent().append(vistaModule.getAOIHTML());
        }
        else if (selectedVisualMethod == "HEATMAP") {
            clearAOIs();
            $('.vis-network').parent().append(vistaModule.getAOIHTML());
        }
    }


    $(document).ready(function () {
        $('.modal').modal();
        $('select').material_select();

        var size = {
            dataW: 1280,
            dataH: 1024,
            width: 0,
            height: 0
        }

        $('#dataSelectionList').delegate("li", "click", function () { // Stimuli seçme tuşu
            selectedStimuliName = $(this).data("stimuliname");
        });

        $('#dataSelectionButton').on("click", function () { // DRAW tuşuna basınca olan fonksiyon
            resetVisualMethods();
            vistaModule.removeAOIs();
            vistaModule.showGazePath(selectedStimuliName, filter[selectedStimuliName]);
        });

        $('#dataSelectionList').delegate(".participant", "click", function () {
            if ($(this).val() == 1) {
                var participants = new Array();
                var index = filter[$(this).data("name")].participants.indexOf($(this).data("participant"));
                for (var i = 0; filter[$(this).data("name")].participants.length > i; i++) {
                    if (i != index) {
                        participants.push(filter[$(this).data("name")].participants[i]);
                    }
                }
                filter[$(this).data("name")].participants = participants;
                $(this).val(0);
            } else {
                filter[$(this).data("name")].participants.push($(this).data("participant"));
                $(this).val(1);
            }
        });

        $('#dataSelectionList').delegate(".imgurl", "change", function () {
            var file = $(this).prop('files')[0];
            var name = $(this).data("name");

            if (file) {
                var reader = new FileReader();
                reader.onload = function () {
                    filter[name].img = reader.result;
                }
                reader.readAsDataURL(file);
            } else {
                filter[$(this).data("name")].img = null;
            }
        });

        $('#visualMethodSelector').delegate("li", "click", function (event) {
            event.preventDefault();
            if (!$(this).hasClass("disabled") && selectedStimuliName != "") {
                selectedVisualMethod = $(this).data("type");
                if (selectedVisualMethod != prevVisualMethod) {

                    if (selectedVisualMethod == "GAZEPATH") {
                        resetVisualMethods();
                        drawAOIs();
                        vistaModule.showGazePath(selectedStimuliName);
                        vistaModule.addAOIBlock(false);
                    }
                    else if (selectedVisualMethod == "HEATMAP") {
                        if ($(".heatmap-canvas").is(":hidden"))
                            $(".heatmap-canvas").show();
                        drawAOIs();
                        vistaModule.generateHeatmap(selectedStimuliName);
                        $(".heatmap-canvas").prependTo($(".vis-network"));
                        prevVisualMethod = "HEATMAP";
                    }

                    else if (selectedVisualMethod == "STAMAP") {
                        $(".heatmap-canvas").hide();
                        vistaModule.showSTAMap(selectedStimuliName, settings.sta, filter[selectedStimuliName]);
                        vistaModule.addAOIBlock(true);
                    }
                    else if (selectedVisualMethod == "AnimatedSTA") {
                        drawAOIs();
                        vistaModule.animatedSTAMap(selectedStimuliName, settings.sta, filter[selectedStimuliName]);
                    }
                    $(this).parent().find("a").removeClass("active");
                    $(this).find("li").addClass("active");
                }
            }
        });

        $('#methodHeatMap').on("click", function () {
            resetForHeatmapMethod();
        });

        $('#menuTrigger').on('click', function (event) {
            if (discovery == true) {
                $('#menuTriggerTab').tapTarget('close');
                event.preventDefault();
            }
        });

        $('#dataSelectionTrigger').on('click', function () {
            $(this).removeClass('pulse');
        });

        $('#managementButton').on('click', function () {
            if ($('#setting_width').val() != "") {
                settings.sta.resX = $('#setting_width').val();
            } else {
                $('#setting_width').val(settings.sta.resX);
            }

            if ($('#setting_height').val() != "") {
                settings.sta.resY = $('#setting_height').val();
            } else {
                $('#setting_height').val(settings.sta.resY);
            }

            if ($('#setting_inch').val() != "") {
                settings.sta.sizeOfScreen = $('#setting_inch').val();
            } else {
                $('#setting_inch').val(settings.sta.sizeOfScreen);
            }

            if ($('#setting_distance').val() != "") {
                settings.sta.distance = $('#setting_distance').val();
            } else {
                $('#setting_distance').val(settings.sta.distance);
            }

            if ($('#setting_daccuracy').val() != "") {
                settings.sta.daccuracy = $('#setting_daccuracy').val();
            } else {
                $('#setting_daccuracy').val(settings.sta.daccuracy);
            }
            if ($('#setting_tolarancelevel').val() != "") {
                settings.sta.tlevel = $('#setting_tolarancelevel').val();
            } else {
                $('#setting_tolarancelevel').val(settings.sta.tlevel);
            }
            if ($('#setting_highestfidelity').is(":checked")) {
                settings.sta.hfidelity = true;
            } else {
                settings.sta.hfidelity = false;
            }
        });


        size.width = $('#map').width();
        size.height = size.width * (size.dataH / size.dataW);
        $('#map').height(size.height);

        $('#mapLoader').css("left", (size.width - $('#mapLoader').width()) / 2);
        $('#mapLoader').css("top", (size.height - $('#mapLoader').height()) / 2);

        vistaModule = new vista(listener, mapContainer, size, settings.staAddress);
        vistaModule.addAOIBlock(true);
        $('#menuTriggerTab').tapTarget('open');

        $('#setting_width').val(settings.sta.resX);
        $('#setting_height').val(settings.sta.resY);
        $('#setting_inch').val(settings.sta.sizeOfScreen);
        $('#setting_distance').val(settings.sta.distance);
        $('#setting_daccuracy').val(settings.sta.daccuracy);
        $('#setting_tolarancelevel').val(settings.sta.tlevel);
        $('#setting_higestfidelity').prop('checked', settings.sta.hfidelity);

        //Handles resize event
        $(window).bind('resize', function (event) {
            if (window.RT) {
                clearTimeout(window.RT);
            }
            window.RT = setTimeout(function () {

                this.location.reload(false);
            }, 100);
        });
    });
</script>

</html>